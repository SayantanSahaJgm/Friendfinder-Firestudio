/**
 * @description This ruleset enforces a strict user-ownership model for user profiles and a public-read, owner-write model for posts and stories.
 * @dataStructure
 *  - /users/{userId}: Stores user profile data, accessible only by the user themselves.
 *  - /posts/{postId}: Stores posts, publicly readable but writable only by the post's author.
 *  - /posts/{postId}/likes/{likeId}: Stores likes for a post, accessible only with a valid authentication.
 *  - /posts/{postId}/comments/{commentId}: Stores comments for a post, accessible only with a valid authentication.
 *  - /stories/{storyId}: Stores stories, publicly readable but writable only by the story's author.
 *  - /friendRequests/{friendRequestId}: Stores friendRequests, accessible only to the two users involved.
 * @keySecurityDecisions
 *  - Users can only read and write their own profile data. Listing all users is disallowed.
 *  - Posts and stories are publicly readable, but only the author can create, update, or delete them.
 *  - The ruleset does NOT implement complex data validation in this prototype phase.
 *  - Data denormalization is used on Posts and Stories to improve performance and enable simpler rules.
 *  - The `id` field of the user document must match the `userId` in the path.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-ownership for user profiles.
     * @path /users/{userId}
     * @allow (create) User bEm19KunXURQsSiTSBRgkmabzkd2 can create their own profile at /users/bEm19KunXURQsSiTSBRgkmabzkd2.
     * @allow (get) User bEm19KunXURQsSiTSBRgkmabzkd2 can read their own profile.
     * @allow (update) User bEm19KunXURQsSiTSBRgkmabzkd2 can update their own profile.
     * @allow (delete) User bEm19KunXURQsSiTSBRgkmabzkd2 can delete their own profile.
     * @deny (create) User otherUser cannot create a profile for bEm19KunXURQsSiTSBRgkmabzkd2.
     * @deny (get) Other users cannot read bEm19KunXURQsSiTSBRgkmabzkd2's profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return request.auth != null && request.auth.uid == userId && resource.data.id == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to posts, but restricts write access to the post's author.
     * @path /posts/{postId}
     * @allow (get) Any user can read a post.
     * @allow (list) Any user can list posts.
     * @allow (create) User bEm19KunXURQsSiTSBRgkmabzkd2 can create a post with userId matching their auth ID.
     * @allow (update) User bEm19KunXURQsSiTSBRgkmabzkd2 can update their own post.
     * @allow (delete) User bEm19KunXURQsSiTSBRgkmabzkd2 can delete their own post.
     * @deny (create) User otherUser cannot create a post with userId belonging to bEm19KunXURQsSiTSBRgkmabzkd2.
     * @deny (update) User otherUser cannot update a post belonging to bEm19KunXURQsSiTSBRgkmabzkd2.
     * @deny (delete) User otherUser cannot delete a post belonging to bEm19KunXURQsSiTSBRgkmabzkd2.
     * @principle Public read, owner-only writes.
     */
    match /posts/{postId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner() {
        return request.auth != null && resource.data.userId == request.auth.uid;
      }
      allow get: if true;
      allow list: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner();
      allow delete: if isExistingOwner();
    }

    /**
     * @description Restricts access to likes to authenticated users.
     * @path /posts/{postId}/likes/{likeId}
     * @allow (get) Authenticated user can get a like.
     * @allow (list) Authenticated user can list likes.
     * @allow (create) Authenticated user can create a like.
     * @allow (update) Authenticated user can update a like.
     * @allow (delete) Authenticated user can delete a like.
     * @deny (get) Unauthenticated user cannot get a like.
     * @deny (list) Unauthenticated user cannot list likes.
     * @principle Requires authentication for access.
     */
    match /posts/{postId}/likes/{likeId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Restricts access to comments to authenticated users.
     * @path /posts/{postId}/comments/{commentId}
     * @allow (get) Authenticated user can get a comment.
     * @allow (list) Authenticated user can list comments.
     * @allow (create) Authenticated user can create a comment.
     * @allow (update) Authenticated user can update a comment.
     * @allow (delete) Authenticated user can delete a comment.
     * @deny (get) Unauthenticated user cannot get a comment.
     * @deny (list) Unauthenticated user cannot list comments.
     * @principle Requires authentication for access.
     */
    match /posts/{postId}/comments/{commentId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to stories, but restricts write access to the story's author.
     * @path /stories/{storyId}
     * @allow (get) Any user can read a story.
     * @allow (list) Any user can list stories.
     * @allow (create) User bEm19KunXURQsSiTSBRgkmabzkd2 can create a story with userId matching their auth ID.
     * @allow (update) User bEm19KunXURQsSiTSBRgkmabzkd2 can update their own story.
     * @allow (delete) User bEm19KunXURQsSiTSBRgkmabzkd2 can delete their own story.
     * @deny (create) User otherUser cannot create a story with userId belonging to bEm19KunXURQsSiTSBRgkmabzkd2.
     * @deny (update) User otherUser cannot update a story belonging to bEm19KunXURQsSiTSBRgkmabzkd2.
     * @deny (delete) User otherUser cannot delete a story belonging to bEm19KunXURQsSiTSBRgkmabzkd2.
     * @principle Public read, owner-only writes.
     */
    match /stories/{storyId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner() {
        return request.auth != null && resource.data.userId == request.auth.uid;
      }
      allow get: if true;
      allow list: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner();
      allow delete: if isExistingOwner();
    }

    /**
     * @description Controls access to friend requests, allowing read/write only to the involved users.
     * @path /friendRequests/{friendRequestId}
     * @allow (get) User bEm19KunXURQsSiTSBRgkmabzkd2 can read a friend request if they are the sender or receiver.
     * @allow (list) Listing of friend requests is denied.
     * @allow (create) User bEm19KunXURQsSiTSBRgkmabzkd2 can create a friend request.
     * @allow (update) User bEm19KunXURQsSiTSBRgkmabzkd2 can update a friend request if they are the sender or receiver.
     * @allow (delete) User bEm19KunXURQsSiTSBRgkmabzkd2 can delete a friend request if they are the sender or receiver.
     * @deny (get) User otherUser cannot read a friend request if they are not involved.
     * @deny (update) User otherUser cannot update a friend request if they are not involved.
     * @deny (delete) User otherUser cannot delete a friend request if they are not involved.
     * @principle Shared access based on document fields.
     */
    match /friendRequests/{friendRequestId} {
        function isParticipant(from, to) {
            return request.auth != null && (request.auth.uid == from || request.auth.uid == to);
        }
        function isExistingParticipant() {
            return request.auth != null && (resource.data.from == request.auth.uid || resource.data.to == request.auth.uid);
        }

        allow get: if isExistingParticipant();
        allow list: if false;
        allow create: if request.auth != null && (request.auth.uid == request.resource.data.from || request.auth.uid == request.resource.data.to);
        allow update: if isExistingParticipant();
        allow delete: if isExistingParticipant();
    }
  }
}