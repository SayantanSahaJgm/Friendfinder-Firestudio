/**
 * @file Firestore Security Rules
 * @version 2
 *
 * @description
 * This ruleset enforces a strict user-ownership model for user profiles and
 * their associated data, while allowing public read access to posts and stories.
 *
 * Data Structure:
 * - /users/{userId}: Stores private user profile data, accessible only to the
 *   authenticated user with a matching ID.
 * - /posts/{postId}: Stores user-generated posts.  Readable by all, but
 *   creatable, updatable, and deletable only by the owner.
 * - /posts/{postId}/likes/{likeId}: Stores likes for posts. Only the user who created the like can manage it.
 * - /posts/{postId}/comments/{commentId}: Stores comments for posts. Only the user who created the comment can manage it.
 * - /stories/{storyId}: Stores user-generated stories. Readable by all, creatable,
 *   updatable, and deletable only by the owner.
 * - /friendRequests/{requestId}: Stores friend requests. Writeable by either the sender or receiver.
 *
 * Key Security Decisions:
 * - User data is strictly private and accessible only to the owning user.
 * - Posts and stories are publicly readable, but only the owner can modify them.
 * - Listing users is not permitted to protect user privacy.
 *
 * Denormalization for Authorization:
 * - Posts denormalize user data (username, profilePictureUrl) to enable public
 *   read access without requiring authentication checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to manage their own profile data.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile if authenticated as 'user123'.
     * @allow (update) User with ID 'user123' can update their profile if authenticated as 'user123'.
     * @allow (delete) User with ID 'user123' can delete their profile if authenticated as 'user123'.
     * @deny (create) User with ID 'user456' cannot create a profile for 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      // Helper function to check if the request is made by the owner of the user document.
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      // Allow the user to read their own document.
      allow get: if isOwner(userId);

      // Prevent listing of all users.
      allow list: if false;

      // Allow a user to create their own document, but enforce that the userId matches.
      allow create: if isOwner(userId);

      // Allow a user to update their own document. Enforce immutability of the userId.
      allow update: if isOwner(userId);

      // Allow a user to delete their own document.
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows anyone to read posts, but only the owner can create, update, or delete them.
     * @path /posts/{postId}
     * @allow (get) Any user can read a post.
     * @allow (list) Any user can list posts.
     * @allow (create) User with ID 'user123' can create a post with authorId 'user123'.
     * @allow (update) User with ID 'user123' can update a post if they are the author.
     * @allow (delete) User with ID 'user123' can delete a post if they are the author.
     * @deny (create) User with ID 'user456' cannot create a post with authorId 'user123'.
     * @principle Allows public read access with owner-only writes.
     */
    match /posts/{postId} {
      // Allows posts to be readable
      allow get, list: if true;

      // Allows the post creator to create a post if the userId field matches their id
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;

      // Only the owner of the post can update/delete it
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Allows users to manage their own likes on a post.
     * @path /posts/{postId}/likes/{likeId}
     * @allow (create) User with ID 'user123' can create a like on a post.
     * @allow (update) User with ID 'user123' can update their like on a post.
     * @allow (delete) User with ID 'user123' can delete their like on a post.
     * @deny (create) User with ID 'user456' cannot create a like for 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /posts/{postId}/likes/{likeId} {
      // Allow anyone to read the like
      allow get, list: if true;

      // Allow a user to create their own like document, but enforce that the userId matches.
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;

      // Allow a user to update their own like document.
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;

      // Allow a user to delete their own like document.
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Allows users to manage their own comments on a post.
     * @path /posts/{postId}/comments/{commentId}
     * @allow (create) User with ID 'user123' can create a comment on a post.
     * @allow (update) User with ID 'user123' can update their comment on a post.
     * @allow (delete) User with ID 'user123' can delete their comment on a post.
     * @deny (create) User with ID 'user456' cannot create a comment for 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /posts/{postId}/comments/{commentId} {
      // Allow anyone to read the comment
      allow get, list: if true;

      // Allow a user to create their own comment document, but enforce that the userId matches.
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;

      // Allow a user to update their own comment document.
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;

      // Allow a user to delete their own comment document.
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Allows anyone to read stories, but only the owner can create, update, or delete them.
     * @path /stories/{storyId}
     * @allow (get) Any user can read a story.
     * @allow (list) Any user can list stories.
     * @allow (create) User with ID 'user123' can create a story with authorId 'user123'.
     * @allow (update) User with ID 'user123' can update a story if they are the author.
     * @allow (delete) User with ID 'user123' can delete a story if they are the author.
     * @deny (create) User with ID 'user456' cannot create a story with authorId 'user123'.
     * @principle Allows public read access with owner-only writes.
     */
    match /stories/{storyId} {
      // Allows stories to be readable
      allow get, list: if true;

      // Allows the post creator to create a story if the userId field matches their id
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;

      // Only the owner of the post can update/delete it
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Allows users to create, update, and delete friend requests, but only if they are the sender or receiver.
     * @path /friendRequests/{requestId}
     * @allow (create) User with ID 'user123' can create a friend request to 'user456'.
     * @allow (update) User with ID 'user123' or 'user456' can update the friend request status.
     * @allow (delete) User with ID 'user123' or 'user456' can delete the friend request.
     * @deny (create) User with ID 'user789' cannot create a friend request between 'user123' and 'user456'.
     * @principle Allows either party to modify the friend request.
     */
    match /friendRequests/{requestId} {
        allow get, list: if true;

        allow create: if request.auth != null && (request.resource.data.from == request.auth.uid || request.resource.data.to == request.auth.uid);
        allow update: if request.auth != null && (resource.data.from == request.auth.uid || resource.data.to == request.auth.uid);
        allow delete: if request.auth != null && (resource.data.from == request.auth.uid || resource.data.to == request.auth.uid);
    }
  }
}