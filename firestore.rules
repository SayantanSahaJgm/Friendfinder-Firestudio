/**
 * @fileoverview Firestore Security Rules for FriendFinder App
 *
 * Core Philosophy:
 * This ruleset prioritizes a secure, owner-centric model for user data while allowing public access to posts and stories.
 * User data is strictly controlled by the user themselves. Public content (posts, stories) is readable by everyone,
 * but write access is restricted to the owner.
 *
 * Data Structure:
 * - /users/{userId}: Stores private user profile data. Only the user can read/write their own data.
 * - /posts/{postId}: Stores user posts. Publicly readable, owner-only write access.
 * - /posts/{postId}/likes/{likeId}: Stores likes for each post.
 * - /posts/{postId}/comments/{commentId}: Stores comments for each post.
 * - /stories/{storyId}: Stores user stories. Publicly readable, owner-only write access.
 * - /friendRequests/{requestId}: Stores friend requests between users.
 *
 * Key Security Decisions:
 * - User listing is explicitly denied to protect user privacy.
 * - Public read access is granted to the 'posts' and 'stories' collections.
 * - Strict ownership is enforced for all user-specific data and content creation.
 *
 * Denormalization for Authorization:
 * - The 'Post' and 'Story' entities require a 'userId' field to enable owner-only writes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures user profiles. Only the user can read, update, or delete their own profile.
     * @path /users/{userId}
     * @allow (create, update, delete) if request.auth.uid == userId
     * @allow (get) if request.auth.uid == userId
     * @deny (list) Always deny listing all users.
     * @deny (create, update, delete) if request.auth.uid != userId
     * @deny (get) if request.auth.uid != userId
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // User listing is not permitted.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Manages posts. Allows public reads, but restricts writes to the post owner.
     * @path /posts/{postId}
     * @allow (get, list) if true
     * @allow (create) if request.auth.uid == request.resource.data.userId
     * @allow (update, delete) if request.auth.uid == resource.data.userId
     * @deny (create) if request.auth.uid != request.resource.data.userId
     * @deny (update, delete) if request.auth.uid != resource.data.userId
     * @principle Allows public reads, enforces ownership for write operations on posts.
     */
    match /posts/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && request.resource.data.userId == request.auth.uid;

            match /likes/{likeId} {
                allow get, list: if true;
                allow create: if isSignedIn();
                allow update: if false;
                allow delete: if isSignedIn();
        }

        match /comments/{commentId} {
                allow get, list: if true;
                allow create: if isSignedIn();
                allow update: if false;
                allow delete: if isSignedIn();
        }
    }

    /**
     * @description Manages stories. Allows public reads, but restricts writes to the story owner.
     * @path /stories/{storyId}
     */
    match /stories/{storyId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    /**
     * @description Manages friend requests.
     * @path /friendRequests/{requestId}
     */
    match /friendRequests/{requestId} {
        function isSignedIn() {
          return request.auth != null;
        }

        allow get: if isSignedIn() && (resource.data.to == request.auth.uid || resource.data.from == request.auth.uid);
        allow list: if false;
        allow create: if isSignedIn() && request.resource.data.from == request.auth.uid;
        allow update: if isSignedIn() && (request.resource.data.to == request.auth.uid || request.resource.data.from == request.auth.uid);
        allow delete: if isSignedIn() && (resource.data.to == request.auth.uid || resource.data.from == request.auth.uid);
    }
  }
}