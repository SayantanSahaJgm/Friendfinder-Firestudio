/**
 * @fileoverview Firestore Security Rules for FriendFinder App
 *
 * Core Philosophy:
 * This ruleset prioritizes a user-centric security model where users primarily own and control their data. It aims to balance open discovery of content with strict authorization for modifications.
 *
 * Data Structure:
 * - /users/{userId}: Stores private user profile data, accessible only to the owning user.
 * - /posts/{postId}: Stores publicly visible posts.  Write access is restricted to the post's author.
 * - /posts/{postId}/likes/{likeId}:  Likes associated with a specific post, write access to the user who creates the like.
 * - /posts/{postId}/comments/{commentId}: Comments associated with a specific post, write access to the user who creates the comment.
 * - /stories/{storyId}: Stores publicly visible stories. Write access is restricted to the story's author.
 * - /friendRequests/{requestId}: Stores friend requests between users, access is restricted to involved users.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data under /users/{userId}.
 * - Listing of users is disallowed to protect privacy.
 * - Posts and stories are publicly readable, but only the author can modify or delete them.
 * - The rules are designed to be data-shape agnostic to allow for rapid prototyping, but enforce strong authorization.
 *
 * Denormalization for Authorization:
 * - Posts and stories include a `userId` field to enable simple owner-based write rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles. Only the user can read/write their own profile.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create their profile at /users/user123 if request.auth.uid == 'user123'.
     * @allow (get, update, delete) - User with UID 'user123' can read, update, and delete their profile at /users/user123.
     * @deny (create) - User with UID 'user456' cannot create a profile at /users/user123.
     * @deny (get, update, delete) - User with UID 'user456' cannot read, update or delete the profile at /users/user123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Secure posts. Publicly readable, but only the author can modify or delete.
     * @path /posts/{postId}
     * @allow (get, list) - Any user can read any post.
     * @allow (create) - User with UID 'user123' can create a post with userId: 'user123'.
     * @allow (update, delete) - User with UID 'user123' can update/delete post with userId: 'user123' if they are the author.
     * @deny (create) - User with UID 'user456' cannot create a post with userId: 'user123'.
     * @deny (update, delete) - User with UID 'user456' cannot update/delete post with userId: 'user123'.
     * @principle Allows public read access with owner-only write access.
     */
    match /posts/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    /**
     * @description Secure likes.  Anyone can read, only the liking user can create, delete.
     * @path /posts/{postId}/likes/{likeId}
     * @allow (get, list) - Any user can read likes under a post.
     * @allow (create) - User with UID 'user123' can create a like with userId: 'user123' under any post.
     * @allow (delete) - User with UID 'user123' can delete like with userId: 'user123' under any post.
     * @deny (create) - User with UID 'user456' cannot create a like with userId: 'user123' under any post.
     * @deny (delete) - User with UID 'user456' cannot delete like with userId: 'user123' under any post.
     * @principle Owner-only writes with public read access.
     */
    match /posts/{postId}/likes/{likeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    /**
     * @description Secure comments. Anyone can read, only the commenting user can create, delete.
     * @path /posts/{postId}/comments/{commentId}
     * @allow (get, list) - Any user can read comments under a post.
     * @allow (create) - User with UID 'user123' can create a comment with userId: 'user123' under any post.
     * @allow (delete) - User with UID 'user123' can delete comment with userId: 'user123' under any post.
     * @deny (create) - User with UID 'user456' cannot create a comment with userId: 'user123' under any post.
     * @deny (delete) - User with UID 'user456' cannot delete comment with userId: 'user123' under any post.
     * @principle Owner-only writes with public read access.
     */
    match /posts/{postId}/comments/{commentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Secure stories. Publicly readable, but only the author can modify or delete.
     * @path /stories/{storyId}
     * @allow (get, list) - Any user can read any story.
     * @allow (create) - User with UID 'user123' can create a story with userId: 'user123'.
     * @allow (update, delete) - User with UID 'user123' can update/delete story with userId: 'user123' if they are the author.
     * @deny (create) - User with UID 'user456' cannot create a story with userId: 'user123'.
     * @deny (update, delete) - User with UID 'user456' cannot update/delete story with userId: 'user123'.
     * @principle Allows public read access with owner-only write access.
     */
    match /stories/{storyId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    /**
     * @description Secure friend requests. Only the involved users can read or modify requests.
     * @path /friendRequests/{requestId}
     * @allow (get) - User with UID 'user123' can get a request where they are either the sender (from) or receiver (to).
     * @allow (list) - Deny listing for privacy.
     * @allow (create) - User with UID 'user123' can create a friend request where they are the sender (from). The id must match from_to.
     * @allow (update) - User with UID 'user123' can update a friend request where they are either the sender (from) or receiver (to), only for status changes.
     * @allow (delete) - User with UID 'user123' can delete a friend request where they are either the sender (from) or receiver (to).
     * @deny (create) - User with UID 'user456' cannot create a friend request for users user123 and user789.
     * @deny (update) - User with UID 'user456' cannot update a friend request involving user123 and user789.
     * @deny (delete) - User with UID 'user456' cannot delete a friend request involving user123 and user789.
     * @principle Restricts access to friend requests to involved users.
     */
    match /friendRequests/{requestId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant(from, to) {
          return isSignedIn() && (request.auth.uid == from || request.auth.uid == to);
      }

      function isSelfInitiatedRequest(from, to) {
          return isSignedIn() && request.auth.uid == from && request.resource.data.id == from + "_" + to;
      }

      function isExistingParticipant() {
          return isSignedIn() && (request.auth.uid == resource.data.from || request.auth.uid == resource.data.to);
      }

      allow get: if isExistingParticipant();
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.from == request.auth.uid && request.resource.data.id == request.resource.data.from + "_" + request.resource.data.to;
      allow update: if isExistingParticipant();
      allow delete: if isExistingParticipant();
    }
  }
}